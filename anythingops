#!/bin/bash

echo ""
echo "ğŸš€ Welcome to AnythingOps Setup!"
echo "================================="

# Function to display help menu
show_help() {
  echo ""
  echo "ğŸ“– Usage: anythingops [OPTION]"
  echo "---------------------------------"
  echo "Available options:"
  echo "  --help         Show this help menu"
  echo "  --gitleaks     Install and guide for Gitleaks (Secret Detection)"
  echo "  --gitleaks scan  Run Gitleaks to scan for secrets and generate a report"
  echo "  --gitleaks scan-text  Run Gitleaks to scan for secrets in your text"
  echo "  --docker       Install and guide for Docker (Containerization)"
  echo "---------------------------------"
  echo ""
  exit 0
}

# If no arguments are provided, show help
if [[ "$#" -eq 0 ]]; then
  echo "âŒ No options provided. Use --help to see available commands."
  exit 1
fi

# ---------------------------------
# ğŸ“– Show Help Menu
# ---------------------------------
if [[ "$1" == "--help" ]]; then
  show_help
fi

# ---------------------------------
# ğŸ³ Docker Installation
# ---------------------------------
if [[ "$1" == "--docker" ]]; then
  echo ""
  echo "ğŸ” Checking for Docker installation..."
  echo "---------------------------------"

  if ! command -v docker &>/dev/null; then
    echo ""
    echo "âš ï¸ Docker not found. Installing..."
    echo ""

    if [[ "$OSTYPE" == "darwin"* ]]; then
      echo "ğŸ Detected macOS."
      echo "âš¡ Downloading Docker Desktop..."
      curl -L -o Docker.dmg "https://desktop.docker.com/mac/main/arm64/Docker.dmg"

      echo "ğŸ“‚ Mounting the DMG file..."
      hdiutil attach Docker.dmg

      echo "ğŸš€ Installing Docker..."
      sudo cp -R "/Volumes/Docker/Docker.app" /Applications

      echo "â³ Unmounting and cleaning up..."
      hdiutil detach "/Volumes/Docker"
      rm Docker.dmg

      echo "âœ… Docker installed successfully! Open it from Applications and allow permissions."
      
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
      echo "ğŸ§ Detected Linux."
      sudo apt-get update && sudo apt-get install -y docker.io
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
      echo "ğŸ–¥ï¸ Detected Windows OS."
      echo "ğŸ”¹ Please install Docker Desktop manually: https://www.docker.com/products/docker-desktop"
      exit 1
    else
      echo "âŒ Unsupported OS for automatic Docker installation. Install manually."
      exit 1
    fi

    echo ""
    echo "âœ… Docker installed successfully!"
    echo "---------------------------------"
  else
    echo ""
    echo "âœ… Docker is already installed: $(which docker)"
    echo "---------------------------------"
  fi

  # Docker User Guide Prompt
  echo ""
  echo "â“ Do you need a user guide for Docker? (yes/no): "
  read -r user_choice
  echo ""

  if [[ "$user_choice" == "yes" ]]; then
    echo "ğŸ“– Here is your Docker user guide:"
    echo "================================="
    echo "âœ… Build an image: docker build -t my-app ."
    echo "âœ… Run a container: docker run -d --name my-container -p 8080:8080 my-app"
    echo "âœ… Stop a container: docker stop my-container"
    echo "âœ… Remove a container: docker rm my-container"
    echo "âœ… View logs: docker logs my-container"
    echo "ğŸ¯ More info: https://docs.docker.com/get-started/"
    echo "================================="
  else
    echo "ğŸ³ You're a Docker expert! Go ahead and containerize the world!"
  fi

  echo ""
  echo "âœ… Setup completed!"
  echo "================================="
  exit 0
fi

# ---------------------------------
# ğŸ” Gitleaks Scan for Secrets
# ---------------------------------
if [[ "$1" == "--gitleaks" && "$2" == "scan" ]]; then
  SCAN_PATH="${3:-.}"  # If a third argument is given, use it; otherwise, default to "."

  echo ""
  echo "ğŸ” Running Gitleaks scan for secrets in: $SCAN_PATH"
  echo "---------------------------------"

  if ! command -v gitleaks &>/dev/null; then
    echo "âŒ Gitleaks not found. Please run: anythingops --gitleaks"
    exit 1
  fi

  gitleaks detect -v --source="$SCAN_PATH" --report-path=gitleaks_report.json --report-format=json

  echo ""
  echo "âœ… Scan completed! Report saved as 'gitleaks_report.json'."
  echo "================================="
  exit 0
fi

# ---------------------------------
# ğŸ” Gitleaks Scan for Input Text
# ---------------------------------
if [[ "$1" == "--gitleaks" && "$2" == "scan-text" ]]; then
  INPUT_TEXT="$3"

  if [[ -z "$INPUT_TEXT" ]]; then
    echo "âŒ No input text provided. Usage: anythingops --gitleaks scan-text 'your text here'"
    exit 1
  fi

  echo ""
  echo "ğŸ” Scanning provided text for secrets..."
  echo "---------------------------------"

  if ! command -v gitleaks &>/dev/null; then
    echo "âŒ Gitleaks not found. Please run: anythingops --gitleaks"
    exit 1
  fi

  # Create a temporary file
  TEMP_FILE=$(mktemp)
  echo "$INPUT_TEXT" > "$TEMP_FILE"

  # Run Gitleaks detect with --no-git to avoid repository issues
  gitleaks detect --no-git -v --source="$TEMP_FILE" --report-path=gitleaks_text_report.json --report-format=json

  # Cleanup temporary file
  rm "$TEMP_FILE"

  echo ""
  echo "âœ… Scan completed!"
  echo "================================="
  exit 0
fi

# ---------------------------------
# ğŸ”’ Gitleaks Installation
# ---------------------------------
if [[ "$1" == "--gitleaks" ]]; then
  echo ""
  echo "ğŸ” Checking for Gitleaks installation..."
  echo "---------------------------------"

  if ! command -v gitleaks &>/dev/null; then
    echo ""
    echo "âš ï¸ Gitleaks not found. Installing..."
    echo ""

    if [[ "$OSTYPE" == "darwin"* ]]; then
      echo "ğŸ Detected macOS."
      brew install gitleaks
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
      echo "ğŸ§ Detected Linux."
      sudo apt-get install -y gitleaks
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
      echo "ğŸ–¥ï¸ Detected Windows OS."
      if ! command -v choco &>/dev/null; then
        echo "âŒ Chocolatey not found. Install Chocolatey first: https://chocolatey.org/install"
        exit 1
      fi
      choco install gitleaks -y
    else
      echo "âŒ Unsupported OS for automatic Gitleaks installation. Install manually."
      exit 1
    fi

    echo ""
    echo "âœ… Gitleaks installation complete!"
    echo "---------------------------------"
  else
    echo ""
    echo "âœ… Gitleaks is already installed: $(which gitleaks)"
    echo "---------------------------------"
  fi

  # Gitleaks User Guide Prompt
  echo ""
  echo "â“ Do you need a user guide for Gitleaks? (yes/no): "
  read -r user_choice
  echo ""

  if [[ "$user_choice" == "yes" ]]; then
    echo "ğŸ“– Here is your Gitleaks user guide:"
    echo "================================="
    echo "âœ… Check version: gitleaks version"
    echo "âœ… Run anythingops --gitleaks scan"
    echo "================================="
  else
    echo "ğŸ˜ You're a pro! Go ahead and start saving your secrets... to get exposed by attackers! (Just kiddingâ€”stay secure!)"
  fi

  echo ""
  echo "âœ… Setup completed!"
  echo "================================="
  exit 0
fi

# ---------------------------------
# ğŸš€ Unsupported Option
# ---------------------------------
echo ""
echo "âŒ Invalid option: $1"
echo "Use --help to see available commands."
echo "================================="
exit 1

# ---------------------------------
# ğŸš€ Unsupported Option
# ---------------------------------
echo ""
echo "âŒ Invalid option: $1"
echo "Use --help to see available commands."
echo "================================="
exit 1
